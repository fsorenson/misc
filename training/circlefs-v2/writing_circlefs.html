<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.1.0" />
<title>Writing a fuse filesystem</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:55em">
<div id="header">
<h1>Writing a fuse filesystem</h1>
<span id="author">Frank Sorenson</span><br />
<span id="email"><code>&lt;<a href="mailto:sorenson@redhat.com">sorenson@redhat.com</a>&gt;</code></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>This is intended to be a step-by-step guide to writing a pseudo-filesystem using fuse.</p></div>
<div class="paragraph"><p>Previous versions of this tutorial used <code>fusepy</code> for the python bindings to fuse.  Unfortunately, <code>fusepy</code> has been suffering bitrot, and is no longer a reliable set of bindings, so this version now uses the C bindings for fuse.  This requires the libs and devel components to be installed (fuse3-libs and fuse-devel in Fedora 37).  The C bindings have both a low-level and a high-level interface, and we&#8217;ll just be using the high-level interface here.</p></div>
<div class="paragraph"><p>This filesystem is a silly use of fuse and filesystems in general, but should give an idea of what writing a filesystem entails.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_circlefs_our_example_filesystem">circlefs - our example filesystem</h2>
<div class="sectionbody">
<div class="paragraph"><p>Our example filesystem will be a simple in-memory pseudo-filesystem named circlefs.  circlefs will store one piece of information, <code>radius</code>, which can be changed as desired.</p></div>
<div class="paragraph"><p>In addition to radius, the filesystem will provide files containing the <code>circumference</code> and <code>diameter</code> of a circle with the stored radius, as well as a file containing the value of <code>pi</code>.  All files will be read-write (except for <code>pi</code>, which will be read-only for obvious reasons).  Reading from any file will return either the value of the radius, the value of pi, or the computed value associated with the name of the file.  Modifying any file will result in a corresponding change to radius.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_excuse_me_8230_is_that_a_skeleton_in_your_closet">Excuse me&#8230; is that a skeleton in your closet?</h2>
<div class="sectionbody">
<div class="paragraph"><p>We start out with nothing but the skeleton C code, most of which we&#8217;ll put into a header file:</p></div>
<div class="listingblock">
<div class="title">circlefs.h</div>
<div class="content"><div class="highlight"><pre><span></span><span class="cp">#ifndef __CIRCLEFS_H__</span>
<span class="cp">#define __CIRCLEFS_H__</span>
<span class="cp">#define _GNU_SOURCE</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/sysmacros.h&gt;</span><span class="cp"></span>

<span class="cp">#define FUSE_USE_VERSION 31</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fuse3/fuse.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cp">#endif</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;circlefs.h&quot;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="n">circlefs_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fuse_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_ops</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_houston_we_have_a_filesystem_well_sort_of">Houston, we have a filesystem (well, sort of)</h2>
<div class="sectionbody">
<div class="paragraph"><p>Let&#8217;s compile it and test it out to see what it does (hint: nothing yet):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3
$ mkdir mnt
$ ./circlefs mnt

$ ls -al mnt
ls: cannot access <span class="s1">&#39;mnt&#39;</span>: Function not implemented
$ ls -ald mnt
ls: cannot access <span class="s1">&#39;mnt&#39;</span>: Function not implemented
</pre></div></div></div>
<div class="paragraph"><p>So our filesystem really does nothing at this point.  But hey&#8230;  we did it.  I guess.</p></div>
<div class="paragraph"><p>Let&#8217;s unmount before we forget:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ fusermount -u mnt
</pre></div></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_so_what_8217_s_wrong">So what&#8217;s wrong?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Well, our <code>circlefs_ops</code> struct contains pointers to functions in our userspace program that implement the various kernel-side functions of a filesystem.  In this case, all of our pointers are zero, so we haven&#8217;t told our program what to do when listing the contents of a directory or getting the attributes of a directory entry (such as the root of the filesystem).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_start_implementing_some_functions">Start implementing some functions</h2>
<div class="sectionbody">
<div class="paragraph"><p>In our code, we&#8217;ll implement two functions: <code>readdir</code> and <code>getattr</code></p></div>
<div class="paragraph"><p><code>readdir</code> is like the getdents() syscall, and will return a directory listing (the entries <code>.</code> and <code>..</code>).</p></div>
<div class="paragraph"><p><code>getattr</code> is similar to the stat() syscall, and will return specific information about a particular directory entry.</p></div>
<div class="paragraph"><p>We&#8217;ll also add some defines and helper functions to our <code>circlefs.h</code> as we go (just add the new pieces at the end of the existing content).</p></div>
<div class="listingblock">
<div class="title">circlefs.h</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">09.325608215</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">46.544019437</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-21</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="mi">21</span><span class="p">,</span><span class="mi">27</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="o">+</span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">     </span><span class="c1">// entry name</span>
<span class="o">+</span><span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">st</span><span class="p">;</span><span class="w"> </span><span class="c1">// permissions, inode number, etc.</span>
<span class="o">+</span><span class="p">};</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w">      </span><span class="mi">42</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">FILE_SIZE</span><span class="w">       </span><span class="mi">4096</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">DEVICE_MAJOR</span><span class="w">    </span><span class="mi">42</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">DEVICE_MINOR</span><span class="w">    </span><span class="mi">42</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">NUM_BLOCKS</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">bsize</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bsize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">bsize</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="c1">// helper function to fill a directory entry&#39;s &#39;struct stat&#39;</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="o">*</span><span class="n">ent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getuid</span><span class="p">();</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getgid</span><span class="p">();</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FILE_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NUM_BLOCKS</span><span class="p">(</span><span class="n">FILE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">),</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makedev</span><span class="p">(</span><span class="n">DEVICE_MAJOR</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_MINOR</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="w"> </span><span class="cp">#endif</span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>And the <code>circlefs.c</code> additions just need to be between the definitions for <code>circlefs_data</code> and <code>circlefs_ops</code></p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">37.401244284</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mf">35.636876519</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-4</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="mi">47</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="o">+</span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w">          </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="p">};</span><span class="w"></span>
<span class="o">+</span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="w"> </span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">circlefs_dirents</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="c1">// path doesn&#39;t matter, since we don&#39;t have any subdirs</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">fuse_fill_dir_t</span><span class="w"> </span><span class="n">filler</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="kt">off_t</span><span class="w"> </span><span class="n">start_offset</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">enum</span><span class="w"> </span><span class="n">fuse_readdir_flags</span><span class="w"> </span><span class="n">readdir_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="c1">// The &#39;start_offset&#39; is used in case our directory listing needs to call</span>
<span class="o">+</span><span class="w">       </span><span class="c1">//     into readdir() more than once.  However, our filesystem is very</span>
<span class="o">+</span><span class="w">       </span><span class="c1">//     small, so we&#39;ll probably always start at the beginning of the dir.</span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_offset</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">filler</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">FUSE_FILL_DIR_PLUS</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="o">*</span><span class="n">st</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="o">+</span><span class="w">               </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="n">memcpy</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="p">));</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>And we&#8217;ll plug the two new functions into the <code>circlefs_ops</code> structure:</p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">18</span><span class="o">:</span><span class="mf">35.636876519</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">23.428730431</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-46</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">46</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">getattr</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>Compile and run again:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3
$ ./circlefs mnt

$ ls -alnd mnt
dr-xr-xr-x. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Dec <span class="m">31</span>  <span class="m">1969</span> mnt

$ ls -aln mnt
total <span class="m">102</span>
dr-xr-xr-x. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Dec <span class="m">31</span>  <span class="m">1969</span> .
drwxrwxr-x. <span class="m">3</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">23</span> <span class="m">12</span>:15 ..
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Dec <span class="m">31</span>  <span class="m">1969</span> radius
</pre></div></div></div>
<div class="paragraph"><p>Okay, that&#8217;s a bit more interesting.  Let&#8217;s see what radius contains:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ cat mnt/radius
cat: mnt/radius: Function not implemented

$ fusermount -u mnt
</pre></div></div></div>
<div class="paragraph"><p>Ah.  Well, that makes sense, since we haven&#8217;t implemented the function to allow reading yet.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_what_8217_s_in_the_box">What&#8217;s in the box?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Okay, now that we&#8217;ve got a directory listing, we need to be able to read the radius, so we&#8217;ll add the function to allow reading a file:</p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">39</span><span class="o">:</span><span class="mf">57.625041042</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">56.801020735</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-44</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">44</span><span class="p">,</span><span class="mi">43</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">char</span><span class="w"> </span><span class="n">localbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAN</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="c1">// not a real file</span>
<span class="o">+</span><span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="c1">// try to check whether our value can be expressed as an integer</span>
<span class="o">+</span><span class="w">       </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">int_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">int_val</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">snprintf</span><span class="p">(</span><span class="n">localbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%.36Lf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">snprintf</span><span class="p">(</span><span class="n">localbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="w"> </span><span class="n">PRIu64</span><span class="p">,</span><span class="w"> </span><span class="n">int_val</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">localbuf</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">localbuf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">copied</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>And add the new function into the <code>circlefs_ops</code> structure:</p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">42</span><span class="o">:</span><span class="mf">56.801020735</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">13.936210060</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-85</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">85</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">getattr</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>Compile and run:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3
$ ./circlefs mnt

$ cat mnt/radius
<span class="m">0</span>

$ <span class="nb">echo</span> <span class="m">1</span> &gt; mnt/radius
bash: echo: write error: Function not implemented

$ fusermount -u mnt
</pre></div></div></div>
<div class="paragraph"><p>Okay, so now we can read, but still can&#8217;t write until we add a write function,</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_but_i_want_a_strong_purple_strong_pony">But I want a <strong>purple</strong> pony!</h2>
<div class="sectionbody">
<div class="paragraph"><p>We need to be able to change the radius, so let&#8217;s allow writing to the <code>radius</code>:</p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span><span class="mf">23.303962588</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mf">50.522904649</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-81</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">81</span><span class="p">,</span><span class="mi">33</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">localbuf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">copied</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">endptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// makes no sense to write anywhere but 0</span>
<span class="o">+</span><span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtold</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">endptr</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERANGE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="c1">// out-of range</span>
<span class="o">+</span><span class="w">                       </span><span class="n">endptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="c1">// empty write or bad value</span>
<span class="o">+</span><span class="w">                       </span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HUGE_VAL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">HUGE_VAL</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="c1">// what file is this?</span>
<span class="o">+</span><span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>And add the new function into the <code>circlefs_ops</code> structure:</p></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mo">03</span><span class="o">:</span><span class="mf">50.522904649</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mf">06.739745844</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-114</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">114</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">getattr</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">write</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3
$ ./circlefs mnt

$ cat mnt/radius
<span class="m">0</span>

$ <span class="nb">echo</span> <span class="m">1</span> &gt; mnt/radius
$ cat mnt/radius
<span class="m">1</span>

$ fusermount -u mnt
</pre></div></div></div>
<div class="paragraph"><p>Okay, now we&#8217;re talking!</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_if_only_we_had_a_wheelbarrow">If only we had a wheelbarrow</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now that we can read/write our <code>radius</code>, how about listing, reading, and writing the other files: <code>pi</code>, <code>diameter</code>, <code>circumference</code>, and <code>area</code>?</p></div>
<div class="paragraph"><p>We&#8217;ll add the files to our list of directory entries:</p></div>
<div class="listingblock">
<div class="title">circlefs.c - changes to circlefs_dirents</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">27.991967040</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mf">01.636973864</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-8</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w">          </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0444</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">,</span><span class="w">   </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w"> </span><span class="cp">#define DIRENT_COUNT (ARRAY_SIZE(circlefs_dirents))</span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>And add code to read and write them into the <code>circlefs_read</code> and <code>circlefs_write</code> functions:</p></div>
<div class="listingblock">
<div class="title">circlefs.c - changes to circlefs_read</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">16</span><span class="o">:</span><span class="mf">01.636973864</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">47.068124800</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-61</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">61</span><span class="p">,</span><span class="mi">14</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="c1">// not a real file</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - changes to circlefs_write</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mf">47.068124800</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">44.751415301</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-116</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">116</span><span class="p">,</span><span class="mi">13</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">powl</span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="c1">// what file is this?</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>Compile and run (need to include the math lib now):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3 -lm
$ ./circlefs mnt

$ <span class="k">for</span> f <span class="k">in</span> <span class="o">{</span>radius,diameter,circumference,area,pi<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2"> - </span><span class="k">$(</span>cat mnt/<span class="nv">$f</span><span class="k">)</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">done</span>
radius - <span class="m">0</span>
diameter - <span class="m">0</span>
circumference - <span class="m">0</span>
area - <span class="m">0</span>
pi - <span class="m">3</span>.141592653589793238512808959406186204

$ <span class="nb">echo</span> <span class="m">2</span> &gt; mnt/diameter

$ <span class="k">for</span> f <span class="k">in</span> <span class="o">{</span>radius,diameter,circumference,area,pi<span class="o">}</span> <span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$f</span><span class="s2"> - </span><span class="k">$(</span>cat mnt/<span class="nv">$f</span><span class="k">)</span><span class="s2">&quot;</span> <span class="p">;</span> <span class="k">done</span>
radius - <span class="m">1</span>
diameter - <span class="m">2</span>
circumference - <span class="m">6</span>.283185307179586477025617918812372409
area - <span class="m">3</span>.141592653589793238512808959406186204
pi - <span class="m">3</span>.141592653589793238512808959406186204

$ fusermount -u mnt
</pre></div></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_but_i_don_8217_t_strong_want_strong_to_be_the_ugly_stepsister">But I don&#8217;t <strong>want</strong> to be the ugly stepsister!</h2>
<div class="sectionbody">
<div class="paragraph"><p>You may have noticed that the dates for all the files in our filesystem are set to the epoch, <em>zero</em> in unix time:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ <span class="nv">TZ</span><span class="o">=</span>UTC ls -aln mnt
total <span class="m">298</span>
dr-xr-xr-x. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> .
drwxrwxr-x. <span class="m">3</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">15</span>:35 ..
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> area
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> circumference
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> diameter
-r--r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> pi
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Jan  <span class="m">1</span>  <span class="m">1970</span> radius

$ <span class="nv">TZ</span><span class="o">=</span>UTC stat mnt <span class="p">|</span> grep -E <span class="s1">&#39;Access|Modify|Change|Birth&#39;</span>
Access: <span class="o">(</span><span class="m">0555</span>/dr-xr-xr-x<span class="o">)</span>  Uid: <span class="o">(</span> <span class="m">1000</span>/sorenson<span class="o">)</span>   Gid: <span class="o">(</span> <span class="m">1000</span>/sorenson<span class="o">)</span>
Access: <span class="m">1970</span>-01-01 <span class="m">00</span>:00:00.000000000 +0000
Modify: <span class="m">1970</span>-01-01 <span class="m">00</span>:00:00.000000000 +0000
Change: <span class="m">1970</span>-01-01 <span class="m">00</span>:00:00.000000000 +0000
 Birth: -
</pre></div></div></div>
<div class="paragraph"><p>We don&#8217;t know the actual date that <code>pi</code> was first determined, and probably can&#8217;t represent that date as a timestamp anyway, but we can do something useful with the rest of these.  Let&#8217;s set all the timestamps to the mount time, then update the modify time whenever we change a value.  We can also update the access times whenever we read any of the files.</p></div>
<div class="paragraph"><p>Another ugly thing in our code is that we call <code>getuid()</code> and <code>getgid()</code> for every directory entry, every time:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getuid</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getgid</span><span class="p">();</span><span class="w"></span>
</pre></div></div></div>
<div class="paragraph"><p>Since that&#8217;s pretty inefficient and unnecessary (it&#8217;s not going to change), let&#8217;s just call those functions once while mounting, and then set them to our stored values.</p></div>
<div class="paragraph"><p>This takes us all the way back to the top of our <code>circlefs.h</code> file, where we&#8217;ll add a few timestamps and uid/gid to our circlefs_data:</p></div>
<div class="listingblock">
<div class="title">circlefs.h - updates to circlefs_data</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">10</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mf">46.544019437</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mf">56.387186470</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-19</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">13</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>

<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">modify_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">access_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="o">+</span><span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">;</span><span class="w"></span>

<span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">     </span><span class="c1">// entry name</span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.h - updates to fill_statbuf</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">32</span><span class="o">:</span><span class="mf">56.387186470</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">h</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">36</span><span class="o">:</span><span class="mf">32.822578880</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-42</span><span class="p">,</span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="mi">42</span><span class="p">,</span><span class="mi">16</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>

<span class="w"> </span><span class="c1">// helper function to fill a directory entry&#39;s &#39;struct stat&#39;</span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="o">*</span><span class="n">ent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">-</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getuid</span><span class="p">();</span><span class="w"></span>
<span class="o">-</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getgid</span><span class="p">();</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">gid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FILE_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NUM_BLOCKS</span><span class="p">(</span><span class="n">FILE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makedev</span><span class="p">(</span><span class="n">DEVICE_MAJOR</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_MINOR</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_ctim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_mtim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_atim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="cp">#endif</span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>and update the <em>circlefs_read</em>, <em>circlefs_write</em>, and <em>main</em> functions:</p></div>
<div class="listingblock">
<div class="title">circlefs.c - updates to circlefs_read</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">44.751415301</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">50.001035129</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-91</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">91</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">localbuf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">copied</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - updates to circlefs_write</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">08</span><span class="o">:</span><span class="mf">50.001035129</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mf">38.349570648</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-127</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">127</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="c1">// what file is this?</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>

<span class="o">+</span><span class="w">       </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - updates to main</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">09</span><span class="o">:</span><span class="mf">38.349570648</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mf">34.127188453</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-139</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">139</span><span class="p">,</span><span class="mi">11</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getuid</span><span class="p">();</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getgid</span><span class="p">();</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fuse_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_ops</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>Now, how do the timestamps look?</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3 -lm
$ ./circlefs mnt

$ <span class="nv">TZ</span><span class="o">=</span>UTC ls -aln mnt
total <span class="m">298</span>
dr-xr-xr-x. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 .
drwxrwxr-x. <span class="m">3</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 ..
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 area
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 circumference
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 diameter
-r--r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 pi
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:34 radius

$ <span class="nb">echo</span> <span class="m">10</span> &gt; mnt/radius
$ cat mnt/diameter
<span class="m">20</span>

$ <span class="nv">TZ</span><span class="o">=</span>UTC stat mnt/diameter <span class="p">|</span> grep -E <span class="s1">&#39;Access|Modify|Change|Birth&#39;</span>
Access: <span class="o">(</span><span class="m">0644</span>/-rw-r--r--<span class="o">)</span>  Uid: <span class="o">(</span> <span class="m">1000</span>/sorenson<span class="o">)</span>   Gid: <span class="o">(</span> <span class="m">1000</span>/sorenson<span class="o">)</span>
Access: <span class="m">2023</span>-10-24 <span class="m">16</span>:38:08.199070682 +0000
Modify: <span class="m">2023</span>-10-24 <span class="m">16</span>:38:00.302121398 +0000
Change: <span class="m">2023</span>-10-24 <span class="m">16</span>:34:05.665096412 +0000
 Birth: -

$ fusermount -u mnt
</pre></div></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_that_wasn_8217_t_enough_you_want_more">That wasn&#8217;t enough?  You want more?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Just for kicks, let&#8217;s add a symlink for <code></code>, pointing to <code>pi</code>.  For this, we&#8217;ll add the entry to the directory listing, and implement a <code>readlink</code> function:</p></div>
<div class="listingblock">
<div class="title">circlefs.c - updates to circlefs_dirents</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">10</span><span class="o">:</span><span class="mf">34.127188453</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mf">46.769982004</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-9</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">9</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0444</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w">          </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFLNK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0777</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">,</span><span class="w">   </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - add circlefs_readlink</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span><span class="mf">46.769982004</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">32.309481105</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-131</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">131</span><span class="p">,</span><span class="mi">24</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_readlink</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">circlefs_dirents</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span><span class="w"></span>
<span class="o">+</span><span class="w">                       </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"> </span><span class="c1">// not a symlink</span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"> </span><span class="c1">// no such file</span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - updates to circlefs_ops</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">21</span><span class="o">:</span><span class="mf">32.309481105</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">18.714660133</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-155</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">155</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">getattr</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">readlink</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readlink</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="paragraph"><p>compile and test</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3 -lm
$ ./circlefs mnt

$ <span class="nv">TZ</span><span class="o">=</span>UTC ls -aln mnt
total <span class="m">347</span>
dr-xr-xr-x. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 .
drwxrwxr-x. <span class="m">3</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:55 ..
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 area
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 circumference
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 diameter
-r--r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 pi
-rw-r--r--. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56 radius
lrwxrwxrwx. <span class="m">0</span> <span class="m">1000</span> <span class="m">1000</span> <span class="m">4096</span> Oct <span class="m">24</span> <span class="m">16</span>:56  -&gt; pi

$ fusermount -u mnt
</pre></div></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_what_i_wouldn_8217_t_give_for_a_holocaust_cloak">What I wouldn&#8217;t give for a holocaust cloak!</h2>
<div class="sectionbody">
<div class="paragraph"><p>Of course, no filesystem would be complete without <code>df</code> causing panic over the filesystem being full, so let&#8217;s make it happen.  We&#8217;ll make our filesystem always full:</p></div>
<div class="listingblock">
<div class="title">circlefs.c - add circlefs_statfs</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mf">18.714660133</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mf">23.478372247</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-149</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">149</span><span class="p">,</span><span class="mi">24</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"> </span><span class="c1">// not a symlink</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"> </span><span class="c1">// no such file</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">+</span><span class="c1">// &#39;path&#39; is really irrelevant... our filesystem doesn&#39;t vary based on the path</span>
<span class="o">+</span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">circlefs_statfs</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">statvfs</span><span class="w"> </span><span class="o">*</span><span class="n">stbuf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">struct</span><span class="w"> </span><span class="nc">statvfs</span><span class="w"> </span><span class="n">stvfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_bsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_bfree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_bavail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_ffree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_favail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_NODEV</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ST_NOEXEC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ST_NOSUID</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_frsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">               </span><span class="p">.</span><span class="n">f_namemax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">};</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stbuf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stvfs</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">stvfs</span><span class="p">));</span><span class="w"></span>
<span class="o">+</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="o">+</span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c - update circlefs_ops</div>
<div class="content"><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><span class="o">---</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">27</span><span class="o">:</span><span class="mf">23.478372247</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">circlefs</span><span class="p">.</span><span class="n">c</span><span class="w">  </span><span class="mi">2023-10-28</span><span class="w"> </span><span class="mi">12</span><span class="o">:</span><span class="mi">30</span><span class="o">:</span><span class="mf">46.587623627</span><span class="w"> </span><span class="mo">-0500</span><span class="w"></span>
<span class="err">@@</span><span class="w"> </span><span class="mi">-174</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">174</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="err">@@</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readlink</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readlink</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">       </span><span class="p">.</span><span class="n">statfs</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_statfs</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</pre></div></td></tr></table></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>$ gcc -Wall circlefs.c -o circlefs -g -lfuse3 -lm
$ ./circlefs mnt

$ stat -f mnt
  File: <span class="s2">&quot;mnt&quot;</span>
    ID: <span class="m">0</span>        Namelen: <span class="m">255</span>     Type: fuseblk
Block size: <span class="m">42</span>         Fundamental block size: <span class="m">42</span>
Blocks: Total: <span class="m">8</span>          Free: <span class="m">0</span>          Available: <span class="m">0</span>
Inodes: Total: <span class="m">8</span>          Free: <span class="m">0</span>

$ df mnt
Filesystem     1K-blocks  Used Available Use% Mounted on
circlefs               <span class="m">1</span>     <span class="m">1</span>         <span class="m">0</span> <span class="m">100</span>% /home/sorenson/projects/misc/training/circlefs-v2/mnt

$ df -i mnt
Filesystem     Inodes IUsed IFree IUse% Mounted on
circlefs            <span class="m">8</span>     <span class="m">8</span>     <span class="m">0</span>  <span class="m">100</span>% /home/sorenson/projects/misc/training/circlefs-v2/mnt

$ fusermount -u mnt
</pre></div></div></div>
<div class="paragraph"><p>Excellent!</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_i_did_all_my_chores_can_i_go_out_and_play_now">I did all my chores!  Can I go out and play now?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Our filesystem is <em>complete</em>.  Give it a test, and see if we&#8217;re missing anything.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_think_you_8217_re_a_wise_guy_eh_let_8217_s_see_you_do_this_then">Think you&#8217;re a wise-guy, eh?  Let&#8217;s see you do this, then!</h2>
<div class="sectionbody">
<div class="paragraph"><p>some possible exercises for the reader:</p></div>
<div class="ulist"><ul>
<li>
<p>
make the filesystem size dependent on the radius (or area?) of the circle
</p>
</li>
<li>
<p>
add:
</p>
<div class="ulist"><ul>
<li>
<p>
surface area (of a sphere): 4 * pi * radius<sup>2</sup>
</p>
</li>
<li>
<p>
volume (of a sphere): 4/3 * pi * radius<sup>3</sup>
</p>
</li>
<li>
<p>
allow creation of directories, with each directory containing its own radius (i.e. <em><code>mkdir basketball &amp;&amp; echo 4.7 &gt; basketball/radius</code></em> or <em><code>mkdir golfball &amp;&amp; echo 0.84 &gt; golfball/radius</code></em>)
</p>
</li>
<li>
<p>
alternately, read a file containing a list of ball types and their sizes, and create read-only directories (or even store the balls in an sqlite db)
</p>
</li>
<li>
<p>
units file, so reading from <code>radius</code> and other files will convert (e.g. <em><code>echo cm &gt; units</code></em>), and/or accept units when writing to the files (e.g. <em><code>echo 21.35mm &gt; golfball/radius</code></em>)
</p>
</li>
</ul></div>
</li>
<li>
<p>
implement some other silly filesystem (squarefs, rectanglefs, ?)
</p>
</li>
<li>
<p>
implement multiple silly filesystems, and have the shape type alterable via mount option (options are processed in main() before calling fuse_main)
</p>
</li>
<li>
<p>
implement multiple silly filesystems, and have the shape type alterable on-the-fly via a read-write <code>shape</code> file
</p>
</li>
<li>
<p>
create some less-silly filesystem
</p>
</li>
<li>
<p>
re-implement circlefs inside a real kernel module
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_source">The source</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">circlefs.h</div>
<div class="content"><div class="highlight"><pre><span></span><span class="cp">#ifndef __CIRCLEFS_H__</span>
<span class="cp">#define __CIRCLEFS_H__</span>
<span class="cp">#define _GNU_SOURCE</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/sysmacros.h&gt;</span><span class="cp"></span>

<span class="cp">#define FUSE_USE_VERSION 31</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fuse3/fuse.h&gt;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">modify_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">access_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">uid_t</span><span class="w"> </span><span class="n">uid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span><span class="w">     </span><span class="c1">// entry name</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">st</span><span class="p">;</span><span class="w"> </span><span class="c1">// permissions, inode number, etc.</span>
<span class="p">};</span><span class="w"></span>
<span class="cp">#define ARRAY_SIZE(a) (sizeof(a)/sizeof(a[0]))</span>

<span class="cp">#define BLOCK_SIZE      42</span>
<span class="cp">#define FILE_SIZE       4096</span>
<span class="cp">#define DEVICE_MAJOR    42</span>
<span class="cp">#define DEVICE_MINOR    42</span>

<span class="cp">#define NUM_BLOCKS(size, bsize) ( (size + bsize - 1) / bsize )</span>

<span class="c1">// helper function to fill a directory entry&#39;s &#39;struct stat&#39;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fill_statbuf</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="o">*</span><span class="n">ent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">gid</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FILE_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blksize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NUM_BLOCKS</span><span class="p">(</span><span class="n">FILE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">makedev</span><span class="p">(</span><span class="n">DEVICE_MAJOR</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_MINOR</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_ctim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_mtim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">st</span><span class="p">.</span><span class="n">st_atim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#endif</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title">circlefs.c</div>
<div class="content"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;circlefs.h&quot;</span><span class="cp"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_data</span><span class="w"> </span><span class="n">circlefs_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="nc">circlefs_dirent</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w">          </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFDIR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0555</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">,</span><span class="w">         </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0444</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w">          </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFLNK</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0777</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">,</span><span class="w">   </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="c1">// sphere attributes</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;surface_area&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;volume&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">.</span><span class="n">st</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">st_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S_IFREG</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mo">0644</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">st_ino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="cp">#define DIRENT_COUNT (ARRAY_SIZE(circlefs_dirents))</span>

<span class="c1">// path doesn&#39;t matter, since we don&#39;t have any subdirs</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_readdir</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">fuse_fill_dir_t</span><span class="w"> </span><span class="n">filler</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="kt">off_t</span><span class="w"> </span><span class="n">start_offset</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">enum</span><span class="w"> </span><span class="n">fuse_readdir_flags</span><span class="w"> </span><span class="n">readdir_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// The &#39;start_offset&#39; is used in case our directory listing needs to call</span>
<span class="w">        </span><span class="c1">//     into readdir() more than once.  However, our filesystem is very</span>
<span class="w">        </span><span class="c1">//     small, so we&#39;ll probably always start at the beginning of the dir.</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start_offset</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span><span class="w"></span>
<span class="w">                </span><span class="n">filler</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">FUSE_FILL_DIR_PLUS</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_getattr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="o">*</span><span class="n">st</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="w">                </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">fill_statbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">st</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="p">));</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_read</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">localbuf</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAN</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;surface_area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">powl</span><span class="p">(</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;volume&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">4.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">powl</span><span class="p">(</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">))</span><span class="w"> </span><span class="c1">// not a real file</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// try to check whether our value can be expressed as an integer</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">int_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">int_val</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">snprintf</span><span class="p">(</span><span class="n">localbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%.36Lf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">                </span><span class="n">snprintf</span><span class="p">(</span><span class="n">localbuf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%&quot;</span><span class="w"> </span><span class="n">PRIu64</span><span class="p">,</span><span class="w"> </span><span class="n">int_val</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">localbuf</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">localbuf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">localbuf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">copied</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">copied</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_write</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_file_info</span><span class="w"> </span><span class="o">*</span><span class="n">ffi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">endptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">off</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// makes no sense to write anywhere but 0</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">errno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtold</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">endptr</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">errno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ERANGE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="c1">// out-of range</span>
<span class="w">                        </span><span class="n">endptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="c1">// empty write or bad value</span>
<span class="w">                        </span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">HUGE_VAL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">HUGE_VAL</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;radius&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;diameter&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;circumference&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">powl</span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">M_PIf128</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;surface_area&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrtl</span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;volume&quot;</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cbrtl</span><span class="p">((</span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">M_PIf128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="c1">// what file is this?</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EBADF</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_readlink</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// paths start with &#39;/&#39;, so advance to fix that</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">path</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pi&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENAMETOOLONG</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">circlefs_dirents</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">circlefs_dirents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">))</span><span class="w"></span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span><span class="w"> </span><span class="c1">// not a symlink</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span><span class="w"> </span><span class="c1">// no such file</span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// &#39;path&#39; is really irrelevant... our filesystem doesn&#39;t vary based on the path</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">circlefs_statfs</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">statvfs</span><span class="w"> </span><span class="o">*</span><span class="n">stbuf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">statvfs</span><span class="w"> </span><span class="n">stvfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_bsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_bfree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_bavail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIRENT_COUNT</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_ffree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_favail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_NODEV</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ST_NOEXEC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ST_NOSUID</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_frsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">.</span><span class="n">f_namemax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">stbuf</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stvfs</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">stvfs</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fuse_operations</span><span class="w"> </span><span class="n">circlefs_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readdir</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readdir</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">getattr</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_getattr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">read</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_read</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">write</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_write</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">readlink</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_readlink</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">statfs</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_statfs</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getuid</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getgid</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">modify_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">access_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circlefs_data</span><span class="p">.</span><span class="n">mount_time</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fuse_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circlefs_ops</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div></div></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-11-02 15:06:44 CDT
</div>
</div>
</body>
</html>
